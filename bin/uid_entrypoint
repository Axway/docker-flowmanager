#!/bin/sh

set -euo pipefail
set -x

pid=0

# SIGTERM-handler
term_handler() {
  if [ $pid -ne 0 ]; then
    echo "***Stopping"
    kill $pid
	wait $pid
	exit 0
  fi
  exit 143; # 128 + 15 -- SIGTERM
}

trap 'term_handler' SIGTERM SIGINT

if ! whoami &> /dev/null; then
  if [ -w /etc/passwd ]; then
    echo "${USER_NAME:-default}:x:$(id -u):0:${USER_NAME:-default} user:${HOME}:/sbin/nologin" >> /etc/passwd
  fi
fi


ACCEPT_EULA="${ACCEPT_EULA:-no}"

if [[ $ACCEPT_EULA = "yes" ]]; then
    echo "You have accepted the EULA, the configuration will proceed as normal."
else
    echo "You have not accepted the EULA, please accept it otherwise the configuration will not proceed. Exiting now."
    exit 1
fi

#redirect logs to stdout

FM_LOGS_CONSOLE="${FM_LOGS_CONSOLE:-yes}"

if [[ $FM_LOGS_CONSOLE = "no" ]]; then
	ln -sf /dev/stdout /opt/axway/FlowManager/logs/errout.txt
	ln -sf /dev/stdout /opt/axway/FlowManager/logs/opcmd.log.0
	ln -sf /dev/stdout /opt/axway/FlowManager/logs/stdout.txt
fi

if ${JAVA_HOME+false}; then
  THIS_JAVA_HOME=/usr/lib/jvm/java-1.8-openjdk/jre
else
  THIS_JAVA_HOME=$JAVA_HOME
fi
  
cd /opt/axway/FlowManager
echo "Configuring Product Started"
time java -jar opcmd.jar configure -n -s /opt/axway/FlowManager/conf.properties -env
echo "Configuring Product Ended"

JVM_DEBUG_PARAMS=""
FM_JVM_DEBUG_ENABLED="${FM_JVM_DEBUG_ENABLED:-false}"
if "$FM_JVM_DEBUG_ENABLED" = 'true'; then
	FM_JVM_DEBUG_PORT="${FM_JVM_DEBUG_PORT:-8000}"
	FM_JVM_DEBUG_SUSPEND="${FM_JVM_DEBUG_SUSPEND:-false}"
	JVM_DEBUG_SUSPEND="n";
	if "$FM_JVM_DEBUG_SUSPEND" = 'true'; then JVM_DEBUG_SUSPEND="y"; fi
	JVM_DEBUG_PARAMS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=$JVM_DEBUG_SUSPEND,address=$FM_JVM_DEBUG_PORT"
fi	
echo "$JVM_DEBUG_PARAMS"

JVM_TUNING_PARAMS="-Xmx$FM_JVM_XMX -Xms$FM_JVM_XMS -Xmn$FM_JVM_XMN  -XX:+AggressiveHeap -XX:+HeapDumpOnOutOfMemoryError -server"
echo $JVM_TUNING_PARAMS
JVM_APP_PARAMS="-Djdk.http.auth.proxying.disabledSchemes=\"\" -Djdk.http.auth.tunneling.disabledSchemes=\"\"  -Dgosh.args=--noi"
echo $JVM_APP_PARAMS
APP_CLASSPATH="-Djava.ext.dirs=bin/ext:$THIS_JAVA_HOME/lib/ext -cp bin/opnode-kernel.jar:bin/lib/*"
echo $APP_CLASSPATH
# TODO add: JVM_DEBUG if configured 

echo "Flow Manager Starting ..."
java $JVM_TUNING_PARAMS $JVM_APP_PARAMS $JVM_DEBUG_PARAMS $APP_CLASSPATH com.axway.opnode.kernel.Main startup &
pid="$!"
# echo "Flow Manager Starting ... $pid"

while true
do
  tail -f /dev/null & wait ${!}
done
