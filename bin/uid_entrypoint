#!/bin/sh

set -euo pipefail
set -x

pid=0

# SIGTERM-handler
term_handler() {
  if [ $pid -ne 0 ]; then
    echo "***Stopping"
    java -jar opcmd.jar stop
    exit 0
  fi
  exit 143; # 128 + 15 -- SIGTERM
}

trap 'term_handler' SIGTERM

if ! whoami &> /dev/null; then
  if [ -w /etc/passwd ]; then
    echo "${USER_NAME:-default}:x:$(id -u):0:${USER_NAME:-default} user:${HOME}:/sbin/nologin" >> /etc/passwd
  fi
fi

exec "$@"

ACCEPT_EULA="${ACCEPT_EULA:-no}"

if [[ $ACCEPT_EULA = "yes" ]]; then
    echo "You have accepted the EULA, the configuration will proceed as normal."
else
    echo "You have not accepted the EULA, please accept it otherwise the configuration will not proceed. Exiting now."
    exit 1
fi

#redirect logs to stdout

FC_LOGS_CONSOLE="${FC_LOGS_CONSOLE:-no}"

if [[ $FC_LOGS_CONSOLE = "yes" ]]; then
    mkdir -p $FC_GENERAL_CUSTOM_LOCATION_PATH/logs/
    ln -sf /dev/stdout $FC_GENERAL_CUSTOM_LOCATION_PATH/logs/kernel.log
    ln -sf /dev/stdout $FC_GENERAL_CUSTOM_LOCATION_PATH/logs/opnode.log
    ln -sf /dev/stdout $FC_GENERAL_CUSTOM_LOCATION_PATH/logs/performance.log
else
    echo "Logs are sent to files"
fi

ln -sf /dev/stdout /opt/axway/FlowManager/logs/commonsso.log
ln -sf /dev/stdout /opt/axway/FlowManager/logs/errout.txt
ln -sf /dev/stdout /opt/axway/FlowManager/logs/opcmd.log.0
ln -sf /dev/stdout /opt/axway/FlowManager/logs/opcmd.log.0.1
ln -sf /dev/stdout /opt/axway/FlowManager/logs/stdout.txt


cd /opt/axway/FlowManager
echo "Configuring Product Started"
time java -jar opcmd.jar configure -n -s /opt/axway/FlowManager/conf.properties -env
echo "Configuring Product Ended"


if [ ! -f /opt/axway/FlowManager/runtime/initialized ]; then 
touch ./runtime/initialized
echo "Flow Manager Starting"
java -jar opcmd.jar start &
pid="$!"
echo "Flow Manager Started"
else
echo "Flow Manager Starting"
cd /opt/axway/FlowManager
time java -jar opcmd.jar start &
pid="$!"
echo "Flow Manager Started"
fi



while true
do
  tail -f /dev/null & wait ${!}
done